# -------------------------------
# üîê S√©curit√© & Politiques HTTP
# -------------------------------
<IfModule mod_headers.c>
  # CSP (aucun script inline, pas de nonce/hash)
  Header always unset Content-Security-Policy
  Header always set Content-Security-Policy "default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'none'; script-src 'self'; style-src 'self' 'unsafe-inline'; font-src 'self'; img-src 'self' data:; connect-src 'self'; manifest-src 'self'; worker-src 'self'"

  # S√©curit√© compl√©mentaires
  Header always set X-Content-Type-Options "nosniff"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

  # CORP (compl√©ment utile si un jour COOP/COEP)
  Header always set Cross-Origin-Resource-Policy "same-origin"

  # HSTS (prod uniquement ; n√©cessite HTTPS op√©rationnel)
  Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"

  # Cache cibl√© par type
  <FilesMatch "\.html?$">
    Header set Cache-Control "no-store"
  </FilesMatch>
  <FilesMatch "\.js$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
  <FilesMatch "\.(woff2|svg)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
  <FilesMatch "\.css$">
    Header set Cache-Control "public, max-age=15778463"
  </FilesMatch>

  # Service Worker : autoriser le scope racine si souhait√©
  <FilesMatch "register-sw\.js$">
    Header set Cache-Control "public, max-age=31536000, immutable"
    Header set Service-Worker-Allowed "/"
  </FilesMatch>
</IfModule>

# -------------------------------
# üîÅ Canonical HTTPS + domaine
# -------------------------------
<IfModule mod_rewrite.c>
  RewriteEngine On
  # Laisser passer ACME pour Let's Encrypt
  RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge/
  # Redirection unique vers https://nexbudge.com
  RewriteCond %{HTTPS} !=on [OR]
  RewriteCond %{HTTP_HOST} !=nexbudge.com [NC]
  RewriteRule ^ https://nexbudge.com%{REQUEST_URI} [R=301,L]
</IfModule>

# -------------------------------
# üì¶ Expires (cache navigateur)
# -------------------------------
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType text/css "access plus 6 months"
</IfModule>

# -------------------------------
# üóúÔ∏è Compression (Brotli/Gzip)
# -------------------------------
<IfModule mod_brotli.c>
  BrotliCompressionQuality 5
  AddOutputFilterByType BROTLI_COMPRESS text/html text/plain text/css text/javascript application/javascript application/json application/xml image/svg+xml font/woff2
</IfModule>

<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/css text/javascript application/javascript application/json application/xml image/svg+xml
  # √âvite double-compression
  SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp|mp4|woff2)$ no-gzip=1
</IfModule>

# -------------------------------
# üö´ Erreurs personnalis√©es
# -------------------------------
ErrorDocument 400 /errors/400.html
ErrorDocument 401 /errors/401.html
ErrorDocument 403 /errors/403.html
ErrorDocument 404 /errors/404.html
ErrorDocument 405 /errors/405.html
ErrorDocument 408 /errors/408.html
ErrorDocument 418 /errors/418.html
ErrorDocument 429 /errors/429.html
ErrorDocument 500 /errors/500.html
ErrorDocument 502 /errors/502.html
ErrorDocument 503 /errors/503.html
ErrorDocument 504 /errors/504.html
