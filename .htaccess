# =========================================
# .htaccess ‚Äî NexBudge (Apache)
# =========================================

# -------------------------------
# üîí Interdictions & durcissement
# -------------------------------
# Pas d‚Äôindex de r√©pertoire
Options -Indexes

# Bloque l‚Äôacc√®s aux fichiers sensibles (dotfiles, git, env, conf, sql, bak, ini, log‚Ä¶)
<FilesMatch "(^\.|\.env$|\.git|\.gitignore$|composer\.(json|lock)$|package(-lock)?\.json$|yarn\.lock$|pnpm-lock\.yaml$|webpack\.config\.js$|vite\.config\.(js|ts)$|.*\.(ini|conf|bak|old|sql|log))">
  Require all denied
</FilesMatch>

# -------------------------------
# üîÅ Redirections canoniques s√ªres
# -------------------------------
<IfModule mod_rewrite.c>
  RewriteEngine On

  # Laisser passer ACME et le dossier d‚Äôerreurs (√©vite boucles et casse du HTTP-01)
  RewriteCond %{REQUEST_URI} ^/\.well-known/acme-challenge/ [OR]
  RewriteCond %{REQUEST_URI} ^/errors/
  RewriteRule - - [L]

  # ‚õîÔ∏è Ne jamais r√©√©crire ces ressources "sp√©ciales" (sinon SW √©choue)
  RewriteCond %{REQUEST_URI} ^/service-worker\.js$ [OR]
  RewriteCond %{REQUEST_URI} ^/robots\.txt$ [OR]
  RewriteCond %{REQUEST_URI} ^/sitemap\.xml$ [OR]
  RewriteCond %{REQUEST_URI} ^/manifest\.webmanifest$ [OR]
  RewriteCond %{REQUEST_URI} ^/manifest\.json$
  RewriteRule - - [L]

  # 1) Forcer HTTPS (si on arrive encore en HTTP)
  RewriteCond %{HTTPS} !=on
  RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

  # 2) Forcer le domaine racine (adapter si besoin)
  RewriteCond %{HTTP_HOST} !^nexbudge\.com$ [NC]
  RewriteRule ^ https://nexbudge.com%{REQUEST_URI} [R=301,L]

  # Rediriger les URLs avec .html vers la version sans extension
  RewriteCond %{THE_REQUEST} \s/+(.+?)\.html[\s?] [NC]
  RewriteRule ^ /%1 [R=301,L]
  
  # Ajouter .html en interne pour les fichiers qui existent
  RewriteCond %{REQUEST_FILENAME} !-f
  RewriteCond %{REQUEST_FILENAME} !-d
  RewriteCond %{REQUEST_FILENAME}.html -f
  RewriteRule ^(.*)$ $1.html [L]
</IfModule>

# -------------------------------
# üîê S√©curit√© & Politiques HTTP
# -------------------------------
<IfModule mod_headers.c>
  # CSP stricte (autorise inline scripts/styles si n√©cessaire pour ta page)
  Header always unset Content-Security-Policy
  Header always set Content-Security-Policy "default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'none'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; font-src 'self'; img-src 'self' data:; connect-src 'self'; manifest-src 'self'; worker-src 'self'"

  # Divers durcissements
  Header always set X-Content-Type-Options "nosniff"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
  Header always set Cross-Origin-Resource-Policy "same-origin"

  # HSTS uniquement si on est d√©j√† en HTTPS (√©vite warnings c√¥t√© HTTP)
  Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" "expr=%{HTTPS} == 'on'"

  # Caches cibl√©s par type d‚Äôactif
  <FilesMatch "\.html?$">
    Header set Cache-Control "no-store, must-revalidate"
  </FilesMatch>
  <FilesMatch "\.js$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
  <FilesMatch "\.(woff2|svg)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
  <FilesMatch "\.css$">
    Header set Cache-Control "public, max-age=15778463"
  </FilesMatch>

  # Service Worker (fichier d'enregistrement c√¥t√© page)
  <FilesMatch "register-sw\.js$">
    Header set Cache-Control "public, max-age=31536000, immutable"
    Header set Service-Worker-Allowed "/"
  </FilesMatch>

  # Service Worker script lui-m√™me: pas de cache + scope autoris√© √† la racine
  <FilesMatch "^service-worker\.js$">
    Header unset Cache-Control
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
    Header set Service-Worker-Allowed "/"
    Header set Content-Type "application/javascript; charset=utf-8"
    Header set Accept-Ranges "none"
    Header unset ETag
    FileETag None
  </FilesMatch>

  # Manifeste PWA: type explicite
  <FilesMatch "^manifest\.json$">
    Header set Content-Type "application/manifest+json; charset=utf-8"
  </FilesMatch>
</IfModule>

# -------------------------------
# üì¶ Expires (cache navigateur)
# -------------------------------
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType text/css "access plus 6 months"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType text/javascript "access plus 1 year"
</IfModule>

# -------------------------------
# üóúÔ∏è Compression (Brotli/Gzip)
# -------------------------------
# Brotli : seulement si brotli ET filter sont pr√©sents
<IfModule mod_brotli.c>
  <IfModule mod_filter.c>
    BrotliCompressionQuality 5
    AddOutputFilterByType BROTLI_COMPRESS \
      text/html text/plain text/css text/javascript application/javascript \
      application/json application/xml image/svg+xml
    # (WOFF2 d√©j√† compress√© ‚Üí inutile de le re-compresser)
  </IfModule>
</IfModule>

# Gzip : seulement si deflate ET filter sont pr√©sents
<IfModule mod_deflate.c>
  <IfModule mod_filter.c>
    AddOutputFilterByType DEFLATE \
      text/html text/plain text/css text/javascript application/javascript \
      application/json application/xml image/svg+xml
    # √âvite double-compression
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp|mp4|woff2)$ no-gzip=1
  </IfModule>
</IfModule>

# -------------------------------
# üö´ Pages d‚Äôerreurs personnalis√©es
# -------------------------------
ErrorDocument 400 /errors/400.html
ErrorDocument 401 /errors/401.html
ErrorDocument 403 /errors/403.html
ErrorDocument 404 /errors/404.html
ErrorDocument 405 /errors/405.html
ErrorDocument 408 /errors/408.html
ErrorDocument 429 /errors/429.html
ErrorDocument 500 /errors/500.html
ErrorDocument 502 /errors/502.html
ErrorDocument 503 /errors/503.html
ErrorDocument 504 /errors/504.html

# -------------------------------
# üì¶ Types MIME (s√©curise le type JS)
# -------------------------------
<IfModule mod_mime.c>
  AddType application/javascript .js
  AddType text/javascript .mjs
  AddType application/json .json
  AddType application/manifest+json .webmanifest
  AddType font/woff2 .woff2
  AddType image/svg+xml .svg
</IfModule>