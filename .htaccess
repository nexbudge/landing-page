# =========================================
# .htaccess ‚Äî NexBudge (Apache)
# =========================================

# -------------------------------
# üîí Interdictions & durcissement
# -------------------------------
# Pas d‚Äôindex de r√©pertoire
Options -Indexes

# Bloque l‚Äôacc√®s aux fichiers sensibles (dotfiles, git, env, conf, sql, bak, ini, log‚Ä¶)
<FilesMatch "(^\.|\.env$|\.git|\.gitignore$|composer\.(json|lock)$|package(-lock)?\.json$|yarn\.lock$|pnpm-lock\.yaml$|webpack\.config\.js$|vite\.config\.(js|ts)$|.*\.(ini|conf|bak|old|sql|log))">
  Require all denied
</FilesMatch>

# -------------------------------
# üîÅ Redirections canoniques s√ªres
# -------------------------------
<IfModule mod_rewrite.c>
  RewriteEngine On

  # Laisser passer ACME et le dossier d‚Äôerreurs (√©vite boucles et casse du HTTP-01)
  RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge/
  RewriteCond %{REQUEST_URI} !^/errors/

  # 1) Forcer HTTPS (ne pas utiliser [OR] ici)
  RewriteCond %{HTTPS} !=on
  RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

  # 2) Forcer le domaine racine (adapter si besoin)
  RewriteCond %{HTTP_HOST} !^nexbudge\.com$ [NC]
  RewriteRule ^ https://nexbudge.com%{REQUEST_URI} [R=301,L]
</IfModule>

# -------------------------------
# üîê S√©curit√© & Politiques HTTP
# -------------------------------
<IfModule mod_headers.c>
  # CSP stricte (pas de inline script, styles autoris√©s en inline)
  Header always unset Content-Security-Policy
  Header always set Content-Security-Policy "default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'none'; script-src 'self' 'sha256-0Vpi8SRbiTvzjTAXl2g+yVpxqbLy1oIAEtn/Pt7iFUQ=' 'sha256-DcHr571hCLcGQ136YAf1GrHn9eWCC9HeidsZ6JHhTU4='; style-src 'self' 'unsafe-inline'; font-src 'self'; img-src 'self' data:; connect-src 'self'; manifest-src 'self'; worker-src 'self'"

  # Divers durcissements
  Header always set X-Content-Type-Options "nosniff"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
  Header always set Cross-Origin-Resource-Policy "same-origin"

  # HSTS uniquement en HTTPS (√©vite warnings c√¥t√© HTTP)
  Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" "expr=%{HTTPS} == 'on'"

  # Caches cibl√©s par type d‚Äôactif
  <FilesMatch "\.html?$">
    Header set Cache-Control "no-store"
  </FilesMatch>
  <FilesMatch "\.js$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
  <FilesMatch "\.(woff2|svg)$">
    Header set Cache-Control "public, max-age=31536000, immutable"
  </FilesMatch>
  <FilesMatch "\.css$">
    Header set Cache-Control "public, max-age=15778463"
  </FilesMatch>

  # Service Worker (si utilis√©)
  <FilesMatch "register-sw\.js$">
    Header set Cache-Control "public, max-age=31536000, immutable"
    Header set Service-Worker-Allowed "/"
  </FilesMatch>
</IfModule>

# -------------------------------
# üì¶ Expires (cache navigateur)
# -------------------------------
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType image/svg+xml "access plus 1 year"
  ExpiresByType text/css "access plus 6 months"
  ExpiresByType application/javascript "access plus 1 year"
  ExpiresByType text/javascript "access plus 1 year"
</IfModule>

# -------------------------------
# üóúÔ∏è Compression (Brotli/Gzip)
# -------------------------------
# Brotli : seulement si brotli ET filter sont pr√©sents
<IfModule mod_brotli.c>
  <IfModule mod_filter.c>
    BrotliCompressionQuality 5
    AddOutputFilterByType BROTLI_COMPRESS \
      text/html text/plain text/css text/javascript application/javascript \
      application/json application/xml image/svg+xml
    # (WOFF2 d√©j√† compress√© ‚Üí inutile de le re-compresser)
  </IfModule>
</IfModule>

# Gzip : seulement si deflate ET filter sont pr√©sents
<IfModule mod_deflate.c>
  <IfModule mod_filter.c>
    AddOutputFilterByType DEFLATE \
      text/html text/plain text/css text/javascript application/javascript \
      application/json application/xml image/svg+xml
    # √âvite double-compression
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|webp|mp4|woff2)$ no-gzip=1
  </IfModule>
</IfModule>

# -------------------------------
# üö´ Pages d‚Äôerreurs personnalis√©es
# -------------------------------
# NE PAS d√©finir 418 (non support√© sur ton h√©bergeur)
ErrorDocument 400 /errors/400.html
ErrorDocument 401 /errors/401.html
ErrorDocument 403 /errors/403.html
ErrorDocument 404 /errors/404.html
ErrorDocument 405 /errors/405.html
ErrorDocument 408 /errors/408.html
# ErrorDocument 418 /errors/418.html
ErrorDocument 429 /errors/429.html
ErrorDocument 500 /errors/500.html
ErrorDocument 502 /errors/502.html
ErrorDocument 503 /errors/503.html
ErrorDocument 504 /errors/504.html

# -------------------------------
# (Optionnel) SPA fallback
# -------------------------------
# D√©commente si tu as une SPA (et un index.html c√¥t√© front)
# Pense √† exclure les assets existants pour √©viter 404 d√©guis√©es.
# <IfModule mod_rewrite.c>
#   RewriteEngine On
#   RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge/
#   RewriteCond %{REQUEST_URI} !^/errors/
#   RewriteCond %{REQUEST_FILENAME} !-f
#   RewriteCond %{REQUEST_FILENAME} !-d
#   RewriteRule . /index.html [L]
# </IfModule>

# -------------------------------
# Bloque l‚Äôacc√®s aux dossiers d‚Äôerreurs
# -------------------------------
<IfModule mod_rewrite.c>
  RewriteEngine On
  RewriteCond %{REQUEST_URI} ^/errors/
  RewriteRule ^ - [R=404,L]
</IfModule>