name: 🚀 Deploy website on push

on:
  push:
    branches: [main]

jobs:
  web-deploy:
    name: 🎉 Minify & Deploy
    runs-on: ubuntu-latest

    steps:
      - name: 🚚 Get latest code
        uses: actions/checkout@v2

      - name: 🛠️ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: 📦 Install minifiers
        run: |
          npm install -g html-minifier-terser clean-css-cli terser svgo

      - name: 🧹 Clean and prepare dist folder
        run: |
          rm -rf dist
          mkdir -p dist/assets/css
          mkdir -p dist/assets/js
          mkdir -p dist/assets/img
          mkdir -p dist/assets/fonts
          mkdir -p dist/assets/css/errors
          mkdir -p dist/errors

      - name: ✨ Minify HTML
        run: |
          # Keep inline JS untouched to preserve CSP hashes
          html-minifier-terser index.html -o dist/index.html \
            --collapse-whitespace --remove-comments --minify-css true --minify-js false
          html-minifier-terser .infomaniak-maintenance.html -o dist/.infomaniak-maintenance.html \
            --collapse-whitespace --remove-comments --minify-css true --minify-js true
          html-minifier-terser errors/400.html -o dist/errors/400.html \
            --collapse-whitespace --remove-comments --minify-css true --minify-js true
          html-minifier-terser errors/401.html -o dist/errors/401.html \
            --collapse-whitespace --remove-comments --minify-css true --minify-js true
          html-minifier-terser errors/404.html -o dist/errors/404.html \
            --collapse-whitespace --remove-comments --minify-css true --minify-js true
          html-minifier-terser errors/403.html -o dist/errors/403.html \
            --collapse-whitespace --remove-comments --minify-css true --minify-js true
          html-minifier-terser errors/405.html -o dist/errors/405.html \
            --collapse-whitespace --remove-comments --minify-css true --minify-js true
          html-minifier-terser errors/408.html -o dist/errors/408.html \
            --collapse-whitespace --remove-comments --minify-css true --minify-js true
          html-minifier-terser errors/429.html -o dist/errors/429.html \
            --collapse-whitespace --remove-comments --minify-css true --minify-js true
          html-minifier-terser errors/500.html -o dist/errors/500.html \
            --collapse-whitespace --remove-comments --minify-css true --minify-js true
          html-minifier-terser errors/502.html -o dist/errors/502.html \
            --collapse-whitespace --remove-comments --minify-css true --minify-js true
          html-minifier-terser errors/503.html -o dist/errors/503.html \
            --collapse-whitespace --remove-comments --minify-css true --minify-js true
          html-minifier-terser errors/504.html -o dist/errors/504.html \
            --collapse-whitespace --remove-comments --minify-css true --minify-js true

      - name: ✨ Minify CSS
        run: |
          cleancss -o dist/assets/css/style.css assets/css/style.css
            cleancss -o dist/assets/css/errors/400.css assets/css/errors/400.css
            cleancss -o dist/assets/css/errors/401.css assets/css/errors/401.css
            cleancss -o dist/assets/css/errors/403.css assets/css/errors/403.css
            cleancss -o dist/assets/css/errors/404.css assets/css/errors/404.css
            cleancss -o dist/assets/css/errors/405.css assets/css/errors/405.css
            cleancss -o dist/assets/css/errors/408.css assets/css/errors/408.css
            cleancss -o dist/assets/css/errors/429.css assets/css/errors/429.css
            cleancss -o dist/assets/css/errors/500.css assets/css/errors/500.css
            cleancss -o dist/assets/css/errors/502.css assets/css/errors/502.css
            cleancss -o dist/assets/css/errors/503.css assets/css/errors/503.css
            cleancss -o dist/assets/css/errors/504.css assets/css/errors/504.css

      - name: ✨ Minify JS
        run: |
          BUILD_HASH=$(git rev-parse --short HEAD)
          sed "s/__SW_VERSION__/${BUILD_HASH}/g" assets/js/register-sw.js | terser --compress --mangle -o dist/assets/js/register-sw.js
          terser service-worker.js -o dist/service-worker.js --compress --mangle
          terser assets/js/year.js -o dist/assets/js/year.js --compress --mangle
          terser assets/js/obs-config.js -o dist/assets/js/obs-config.js --compress --mangle

      - name: ✨ Minify JSON
        run: |
          jq -c . < manifest.json > dist/manifest.json

      - name: ✨ Copy images and optimize SVG
        run: |
          mkdir -p dist/assets/img
          cp -r assets/img/* dist/assets/img/ || true
          for svg in dist/assets/img/*.svg; do
            [ -f "$svg" ] && svgo "$svg" -o "$svg"
          done

      - name: 📥 Copy other files
        run: |
          cp robots.txt dist/
          cp .user.ini dist/
          cp .htaccess dist/ || true
          cp -r assets/fonts dist/assets/

      - name: 📂 Sync files via FTP
        uses: webitsbr/github-to-ftp@1.0.1
        with:
          server: ${{ secrets.SERVER }}
          server-dir: ${{ secrets.DIR }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          local-dir: dist/
